<?xml version="1.0" encoding="UTF-8"?>
<network_review_triplet>
    <description>
        PR Review Triplet for networking configuration: router ports, NAT, and firewall settings
    </description>

    <before_config>
        <![CDATA[
# Router Port Configuration - BEFORE
interface GigabitEthernet0/1
 description WAN_INTERFACE
 ip address dhcp
 ip nat outside
 no shutdown
interface GigabitEthernet0/2
 description LAN_INTERFACE
 ip address 192.168.1.1 255.255.255.0
 ip nat inside
 no shutdown
# NAT Configuration - BEFORE
ip nat inside source list 1 interface GigabitEthernet0/1 overload
access-list 1 permit 192.168.1.0 0.0.0.255
# Firewall Rules - BEFORE
ip access-list extended FIREWALL_IN
 permit tcp any any eq 80
 permit tcp any any eq 443
 permit tcp any any eq 22
 deny ip any any
        ]]>
    </before_config>

    <review_comment>
        <![CDATA[
The current networking configuration has several security vulnerabilities:
1. SSH (port 22) is open to any source, which is a security risk
2. The firewall rules are too permissive - allowing HTTP/HTTPS from any source
3. Missing proper logging for denied connections
4. No rate limiting on SSH connections
5. Should add specific rules for internal network management
Recommendations:
- Restrict SSH access to specific management networks only
- Add logging for security analysis
- Implement rate limiting for connection attempts
- Add explicit rules for internal network traffic
        ]]>
    </review_comment>

    <after_config>
        <![CDATA[
# Router Port Configuration - AFTER
interface GigabitEthernet0/1
 description WAN_INTERFACE
 ip address dhcp
 ip nat outside
 ip access-group FIREWALL_IN in
 no shutdown
interface GigabitEthernet0/2
 description LAN_INTERFACE
 ip address 192.168.1.1 255.255.255.0
 ip nat inside
 no shutdown

# NAT Configuration - AFTER
! Keep PAT for outbound internet
ip nat inside source list 1 interface GigabitEthernet0/1 overload
access-list 1 permit 192.168.1.0 0.0.0.255

! Optional: if publishing web, prefer explicit static NAT to a single host (DMZ or dedicated server)
! Replace placeholders as appropriate to avoid overlapping/ambiguous NAT.
! Example:
! ip nat inside source static tcp 192.168.1.100 80 interface GigabitEthernet0/1 80
! ip nat inside source static tcp 192.168.1.100 443 interface GigabitEthernet0/1 443

# Firewall Rules - AFTER (tighter, inbound on WAN)
ip access-list extended FIREWALL_IN
 remark Allow HTTP/HTTPS only to the published service (replace with your public IP or specific host)
 permit tcp any host <WAN_PUBLIC_IP> eq 80
 permit tcp any host <WAN_PUBLIC_IP> eq 443

 remark Allow established return traffic (legacy patterns)
 permit tcp any any established

 remark DHCP client and basic ICMP allowance for troubleshooting
 permit udp any eq 67 any eq 68
 permit icmp any any echo-reply

 remark Do not expose SSH from the internet
 deny tcp any any eq 22

 remark Default deny with logging
 deny ip any any log

# VTY and SSH hardening (restrict management to mgmt CIDR and rate-limit attempts)
ip access-list standard VTY_MGMT
 permit 10.1.1.0 0.0.0.255

line vty 0 4
 access-class VTY_MGMT in
 transport input ssh
 exec-timeout 10 0
 login local

ip ssh version 2
login block-for 60 attempts 3 within 60
ip ssh time-out 30
ip ssh authentication-retries 2

# Logging for security analysis
logging buffered 64000
logging host 192.0.2.10
logging trap informational
service timestamps log datetime msec

# Basic Control Plane Policing (CoPP) for SSH/ICMP (optional baseline)
ip access-list extended COPP-MGMT
 permit tcp any any eq 22
 permit icmp any any echo

class-map match-any CM-COPP-MGMT
 match access-group name COPP-MGMT

policy-map PM-COPP
 class CM-COPP-MGMT
  police 64000 8000 conform-action transmit exceed-action drop

control-plane
 service-policy input PM-COPP
        ]]>
    </after_config>

    <metadata>
        <created_date>2025-01-01</created_date>
        <focus_area>networking</focus_area>
        <technologies>
            <technology>cisco_ios</technology>
            <technology>router_configuration</technology>
            <technology>nat</technology>
            <technology>firewall</technology>
            <technology>access_control_lists</technology>
        </technologies>
        <review_type>security_improvement</review_type>
    </metadata>
</network_review_triplet>
